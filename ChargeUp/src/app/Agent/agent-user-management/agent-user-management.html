<div class="user-management-container">
    <h2 class="pt-2">User Management</h2>

    <div class="toolbar">
        <input type="text" placeholder="Search by name or email" class="search-input" [(ngModel)]="searchTerm"
            (input)="onSearchChange()" />

        <div class="action-buttons">
            <button class="referral-btn" (click)="openReferralModal()" *ngIf="referralLink">
                üîó + REFERRAL LINK
            </button>
            <button *ngIf="AllowUserCreation" class="btn btn-primary" (click)="openAddUserModal()">üë§ ADD NEW
                USER</button>
        </div>
    </div>

    <table class="user-table">
        <thead>
            <tr>
                <th>Actions</th>
                <th (click)="sortData('name')">User Name <span *ngIf="sortColumn === 'name'">{{ sortDirection === 'asc'
                        ? '‚ñ≤' : '‚ñº' }}</span></th>
                <th (click)="sortData('email')">Email <span *ngIf="sortColumn === 'email'">{{ sortDirection === 'asc' ?
                        '‚ñ≤' : '‚ñº' }}</span></th>
                <th (click)="sortData('createdAt')">Date <span *ngIf="sortColumn === 'createdAt'">{{ sortDirection ===
                        'asc' ? '‚ñ≤' : '‚ñº' }}</span></th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let user of paginatedUsers; let i = index">
                <td>
                    <div class="dropdown-wrapper">
                        <button (click)="toggleDropdown(i)" style="border: 0; background-color: white;"><i
                                class="fa-solid fa-gear"></i></button>
                        <div class="dropdown-menu" *ngIf="openDropdownIndex === i">
                            <a (click)="redeem(user)">Redeem</a>
                            <a (click)="openRechargePermissionModal(user)">Recharge Permissions</a>
                            <a (click)="edit(user)">Edit</a>
                            <a (click)="delete(user)">Delete</a>
                        </div>
                    </div>
                </td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.createdAt | date:'MM/dd/yyyy HH:mm:ss' }}</td>
            </tr>
            <tr *ngIf="!hasRecords">
                <td colspan="4" class="no-records">No records found</td>
            </tr>
        </tbody>
    </table>
    <div class="pagination">
        <div class="pagination-info">
            {{ showingRange }}
            <!-- {{ showingRange }} of {{ filteredUsers.length }} -->
        </div>

        <div class="pagination-controls">
            <button (click)="changePage(1)" [disabled]="currentPage === 1">¬´</button>
            <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">‚Äπ</button>

            <button *ngFor="let page of [].constructor(totalPages); let i = index"
                [class.active]="currentPage === (i + 1)" (click)="changePage(i + 1)">
                {{ i + 1 }}
            </button>

            <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">‚Ä∫</button>
            <button (click)="changePage(totalPages)" [disabled]="currentPage === totalPages">¬ª</button>
        </div>

        <div class="items-per-page">
            <label for="items">Items per page:</label>
            <select id="items" (change)="changeItemsPerPage($event)" [value]="itemsPerPage">
                <option *ngFor="let size of [5, 10, 20, 50]" [value]="size">{{ size }}</option>
            </select>
        </div>
    </div>


    <div class="modal-overlay" *ngIf="showModal">
        <div class="modal">
            <span class="close-btn" (click)="closeReferralModal()">‚úñ</span>
            <h3>Generate Referral Link</h3>

            <div class="modal-content">
                <button class="copy-btn" (click)="copyReferralLink()">Copy</button>
                <input type="text" [value]="referralLink" readonly />
            </div>
        </div>
    </div>
    <!-- <div class="modal-overlay" *ngIf="showRedeemModal">
        <div class="modal redeem-modal">
            <div class="modal-header">
                <h3>Redeem Amount</h3>
                <p class="modal-subheader">Redeems may take up to 2 hours</p>
            </div>
            <span class="close-btn" (click)="closeRedeemModal()">‚úñ</span>

            <div class="modal-body">
                <div class="form-group">
                    <label>Account</label>
                    <input type="text" [value]="selectedUser?.name" readonly />
                </div>

                <div class="form-group">
                    <label>Redeem Amount</label>
                    <input type="number" placeholder="e.g. 500" [(ngModel)]="redeemAmount" (input)="calculateTotal()" />
                </div>

                <div class="info-box">
                    <p>Redeem Service Fee @ 5%</p>
                </div>

                <div class="total-amount">
                    <label>Total amount to be redeemed =</label>
                    <span>${{ totalRedeemAmount }}</span>
                </div>

                <div class="warning-box" *ngIf="redeemAmount">
                    *The amount has been rounded down to the nearest lower value.
                </div>

                <div class="form-group">
                    <label>Remark</label>
                    <textarea placeholder="Enter Remark"></textarea>
                </div>
            </div>

            <div class="modal-actions">
                <button class="confirm-btn" (click)="confirmRedeem()">Confirm</button>
                <button class="cancel-btn" (click)="closeRedeemModal()">Cancel</button>
            </div>
        </div>
    </div> -->
    <div class="modal-overlay" *ngIf="showRedeemModal">
        <div class="add-user-modal">
            <div class="modal-header">
                <h3>Redeem Amount</h3>
                <p class="modal-subheader">Redeems may take up to 2 hours</p>
            </div>
            <span class="close-btn" (click)="closeRedeemModal()">‚úñ</span>

            <div class="modal-body">
                <div class="form-group">
                    <label>Account</label>
                    <input type="text" [value]="selectedUser?.name" readonly />
                </div>

                <div class="form-group">
                    <label>Redeem Amount</label>
                    <input type="number" placeholder="e.g. 500" [(ngModel)]="redeemAmount" (input)="calculateTotal()" />
                </div>

                <div class="info-box">
                    <p>Redeem Service Fee @ {{ redeemServiceFeePercent }}%</p>
                    <!-- <p>Available Balance: ${{ agentBalance }}</p> -->
                </div>
                <div class="info-box">
                    <label>Total amount to be redeemed =</label>
                    <span>${{ totalRedeemAmount }}</span>
                </div>

                <div class="warning-box" *ngIf="redeemAmount">
                    *The amount has been rounded down to the nearest lower value.
                </div>

                <div class="form-group">
                    <label>Remark</label>
                    <textarea placeholder="Enter Remark"></textarea>
                </div>
            </div>

            <div class="modal-actions">
                <button class="confirm-btn" (click)="confirmRedeem()">Confirm</button>
                <button class="cancel-btn" (click)="closeRedeemModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- <div class="modal-overlay" *ngIf="showAddUserModal">
        <div class=" add-user-modal">
            <span class="close-btn" (click)="closeAddUserModal()">‚úñ</span>
            <h3>Add New User</h3>

            <div class="modal-body">
                <div class="form-group">
                    <label>User Name</label>
                    <input type="text" [(ngModel)]="newUser.userName" placeholder="e.g. John" />
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" [(ngModel)]="newUser.name" placeholder="e.g. Doe" />
                </div>

                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" [(ngModel)]="newUser.phoneNumber" placeholder="e.g. 0123456789" />
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" [(ngModel)]="newUser.email" placeholder="e.g. johndoe@example.com" />
                </div>


                <div class="form-group">
                    <label>Password</label>
                    <input type="password" [(ngModel)]="newUser.password" />
                </div>

                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" [(ngModel)]="newUser.confirmPassword" />
                </div>
            </div>

            <div class="modal-actions">
                <button class="confirm-btn" (click)="createUser()">Confirm</button>
                <button class="cancel-btn" (click)="closeAddUserModal()">Cancel</button>
            </div>
        </div>
    </div> -->

    <div class="modal-overlay" *ngIf="showAddUserModal">
        <div class="add-user-modal">
            <span class="close-btn" (click)="closeAddUserModal()">‚úñ</span>
            <h3>Add New User</h3>

            <form #addUserForm="ngForm" (ngSubmit)="createUser()" novalidate>
                <div class="modal-body">

                    <!-- Username -->
                    <div class="form-group">
                        <label>User Name</label>
                        <input type="text" name="userName" [(ngModel)]="newUser.userName" required minlength="5"
                            #userName="ngModel" placeholder="e.g. JohnDoe" />
                        <div class="error" *ngIf="userName.invalid && userName.touched">
                            <small *ngIf="userName.errors?.['required']">Username is required.</small>
                            <small *ngIf="userName.errors?.['minlength']">Min 5 characters required.</small>
                        </div>
                    </div>

                    <!-- Full Name -->
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="name" [(ngModel)]="newUser.name" required minlength="5" #name="ngModel"
                            placeholder="e.g. John Doe" />
                        <div class="error" *ngIf="name.invalid && name.touched">
                            <small *ngIf="name.errors?.['required']">Full name is required.</small>
                            <small *ngIf="name.errors?.['minlength']">Min 5 characters required.</small>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" name="phoneNumber" [(ngModel)]="newUser.phoneNumber" required
                            pattern="^[0-9]{10}$" #phone="ngModel" placeholder="e.g. 9876543210" />
                        <div class="error" *ngIf="phone.invalid && phone.touched">
                            <small *ngIf="phone.errors?.['required']">Phone number is required.</small>
                            <small *ngIf="phone.errors?.['pattern']">Enter valid 10-digit number.</small>
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" [(ngModel)]="newUser.email" required email #email="ngModel"
                            placeholder="e.g. johndoe@example.com" />
                        <div class="error" *ngIf="email.invalid && email.touched">
                            <small *ngIf="email.errors?.['required']">Email is required.</small>
                            <small *ngIf="email.errors?.['email']">Enter a valid email address.</small>
                        </div>
                    </div>

                    <!-- Password with Eye Icon -->
                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-wrapper">
                            <input [type]="passwordVisible ? 'text' : 'password'" name="password"
                                [(ngModel)]="newUser.password" required minlength="6" #password="ngModel"
                                placeholder="Enter Password" />
                            <span class="toggle" (click)="passwordVisible = !passwordVisible">
                                {{ passwordVisible ? 'üôà' : 'üëÅÔ∏è' }}
                            </span>
                        </div>
                        <div class="error" *ngIf="password.invalid && password.touched">
                            <small *ngIf="password.errors?.['required']">Password is required.</small>
                            <small *ngIf="password.errors?.['minlength']">Min 6 characters required.</small>
                        </div>
                    </div>

                    <!-- Confirm Password with Eye Icon -->
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <div class="password-wrapper">
                            <input [type]="confirmPasswordVisible ? 'text' : 'password'" name="confirmPassword"
                                [(ngModel)]="newUser.confirmPassword" required #confirmPassword="ngModel"
                                placeholder="Confirm Password" />
                            <span class="toggle" (click)="confirmPasswordVisible = !confirmPasswordVisible">
                                {{ confirmPasswordVisible ? 'üôà' : 'üëÅÔ∏è' }}
                            </span>
                        </div>
                        <div class="error"
                            *ngIf="confirmPassword.touched && newUser.confirmPassword !== newUser.password">
                            <small>Passwords do not match.</small>
                        </div>
                    </div>

                </div>

                <div class="modal-actions">
                    <button type="submit" class="confirm-btn"
                        [disabled]="addUserForm.invalid || newUser.password !== newUser.confirmPassword">
                        Add User
                    </button>
                    <button type="button" class="cancel-btn" (click)="closeAddUserModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div class="modal-overlay" *ngIf="showEditUserModal">
        <div class="add-user-modal">
            <span class="close-btn" (click)="closeEditUserModal()">‚úñ</span>
            <h3>Edit User Details</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" [(ngModel)]="editingUser.username" placeholder="e.g., John" />
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" [(ngModel)]="editingUser.name" placeholder="e.g., Doe" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" [(ngModel)]="editingUser.email" placeholder="e.g., johndoe@example.com" />
                </div>
            </div>
            <div class="modal-actions">
                <button class="confirm-btn" (click)="confirmUpdateUser()">Update</button>
                <button class="cancel-btn" (click)="closeEditUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" *ngIf="showDeleteUserModal">
        <div class="add-user-modal">
            <span class="close-btn" (click)="closeDeleteUserModal()">‚úñ</span>
            <h3>Delete User</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" [ngModel]="deletingUser?.name" disabled />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" [ngModel]="deletingUser?.email" disabled />
                </div>
                <div class="form-group">
                    <label>To confirm this, type "DELETE"</label>
                    <input type="text" [(ngModel)]="deleteConfirmationText" (input)="validateDeleteText()"
                        placeholder="Type DELETE to confirm" />
                    <!-- Error message -->
                    <small *ngIf="deleteError" class="error-text">{{ deleteError }}</small>
                </div>
            </div>
            <div class="modal-actions">
                <button class="confirm-btn" [disabled]="!isDeleteConfirmed"
                    (click)="confirmDeleteUser()">
                    Delete
                </button>
                <button class="cancel-btn" (click)="closeDeleteUserModal()">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" *ngIf="showRechargePermissionModal">
        <div class="add-user-modal">
            <div class="modal-header">
                <h3>Recharge Permissions</h3>
                <span class="close-btn py-2" (click)="closeRechargePermissionModal()">‚úñ</span>
            </div>

            <div class="modal-body">
                <p class="pb-0 mb-0">Select recharge amounts <b> {{ selectedUser?.name }}</b> is allowed to use:</p>
                <div class="checkbox-grid">
                    <label *ngFor="let option of rechargeOptions" class="checkbox-item">
                        <input type="checkbox" [checked]="selectedAmounts.includes(option)"
                            (change)="toggleAmount(option, $event)" />
                        <span>${{ option }}</span>
                    </label>
                </div>
            </div>

            <div class="modal-actions mb-2">
                <button class="confirm-btn px-4" (click)="saveRechargePermissions()">Save</button>
                <button class="cancel-btn" (click)="closeRechargePermissionModal()">Cancel</button>
            </div>
        </div>
    </div>


</div>