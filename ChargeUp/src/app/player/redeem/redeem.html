<div class="redeem-wrapper py-5">
  <div class="container">

    <!-- ===================== -->
    <!-- Redeem Section -->
    <!-- ===================== -->
    <div *ngIf="viewMode === 'main'">
      <div class="redeem-card glass-card p-4 mb-4">
        <h4 class="section-title mb-3">Redeem</h4>

        <!-- Selected Amount Box -->
        <div class="selected-amount-box mb-3 d-flex align-items-center">
          <div class="coin-icon me-2">ü™ô</div>
          <div class="fs-4 fw-bold">{{ selectedAmount || 0 }}</div>
          <input type="text" [(ngModel)]="redeemRemark" class="form-control ms-3" placeholder="Add Transaction Note" />
        </div>

        <!-- Amount Buttons -->
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button *ngFor="let amt of amounts" (click)="selectAmount(amt)" class="amount-btn"
            [ngClass]="{ active: selectedAmount === amt }">
            ü™ô {{ amt }}
          </button>
        </div>

        <!-- Info Text -->
        <div class="d-flex justify-content-between small text-muted mb-3">
          <span>Redeem Service Fee @ {{ activeServiceFee?.serviceFeePercent || 0 }}%</span>
          <span>Redeems may take up to 2 hours</span>
        </div>

        <!-- Redeem Button -->
        <button class="redeem-btn w-100" (click)="openAttentionModal()">
          Redeem Request ‚Üí
        </button>
      </div>

      <!-- Recent Redeem -->
      <!-- Recent Redeem -->
      <div class="recent-card glass-card p-3 mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <button class="total-transactions-btn w-100" (click)="showAllTransactions()">
            Total number of transactions: <span class="ps-2">{{ totalRedeemsCount }}</span>
          </button>
        </div>

        <!-- Subtext in next row -->
        <div class="small text-muted mb-3">
          <b>Last 5 transactions shown here</b>
        </div>

        <div *ngIf="recentRedeems.length > 0" class="mt-3">
          <div *ngFor="let redeem of recentRedeems | slice:0:5" class="row align-items-center border-bottom py-2 mx-3">
            <div class="col-2"> <b>Amount</b> <span class="ps-2">ü™ô{{ redeem.Amount }}</span></div>
            <div class="col-2"><b>Net Amount</b><span class="ps-2">{{ redeem.NetAmount }}</span></div>
            <div class="col-2"><b>Date</b><span class="ps-2">
                {{ redeem.RequestedAt ? (redeem.RequestedAt | date:'dd/MM/yyyy') :
                (redeem.ProcessedAt | date:'dd/MM/yyyy, h:mm a') }}</span>
            </div>
            <div class="col-3 text-start"><b>Status</b><span class="ps-2">
                <span class="badge px-3 py-2" [ngClass]="{
                        'bg-success': redeem.Status?.toLowerCase() === 'success' || redeem.Status?.toLowerCase() === 'completed',
                        'bg-warning text-dark': redeem.Status && redeem.Status.toLowerCase().includes('pending'),
                        'bg-danger': redeem.Status?.toLowerCase() === 'rejected'
                      }">
                  {{ redeem.Status }}
                </span></span>
            </div>
          </div>
        </div>
        <!-- No transactions message -->
        <div *ngIf="recentRedeems.length === 0" class="no-transactions-message mt-3">
          <p>No transactions yet.</p>
          <p>
            You can go to
            <a class="pending-link" (click)="showPendingScreen()">Pending Redeem Requests</a>
            to check all pending transactions.
          </p>
        </div>
      </div>

    </div>

    <!-- ===================== -->
    <!-- All Transactions -->
    <!-- ===================== -->
    <div *ngIf="viewMode === 'allTransactions'" class="glass-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-secondary" (click)="backToMain()">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <h5 class="mb-0">All Transactions ({{ totalRedeemsCount }})</h5>
      </div>

      <div *ngIf="pendingRedeems.length === 0" class="alert alert-info">
        No transactions available.
      </div>

      <div *ngIf="pendingRedeems.length > 0" class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Amount</th>
              <th>Net Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let redeem of paginatedRedeems; let i = index">
              <td>{{ i + 1 }}</td>
              <td>ü™ô {{ redeem.Amount }}</td>
              <td>{{ redeem.NetAmount }}</td>
              <td>
                <span class="badge" [ngClass]="{
                    'bg-success': redeem.Status?.toLowerCase() === 'success' || redeem.Status?.toLowerCase() === 'completed',
                    'bg-warning text-dark': redeem.Status && redeem.Status.toLowerCase().includes('pending'),
                    'bg-danger': redeem.Status?.toLowerCase() === 'rejected'
                  }">
                  {{ redeem.Status }}
                </span>
              </td>
              <td>
                {{ redeem.RequestedAt ? (redeem.RequestedAt | date:'dd/MM/yyyy, h:mm a')
                : (redeem.ProcessedAt | date:'dd/MM/yyyy, h:mm a') }}
              </td>
            </tr>
          </tbody>
        </table>
        <!-- Pagination Controls -->
        <div class="pagination-wrapper d-flex justify-content-between align-items-center mt-3 flex-wrap">

          <!-- Centered Pagination -->
          <div class="pagination-controls mx-auto d-flex align-items-center">
            <button class="btn btn-outline-secondary me-2" [disabled]="currentPage === 1"
              (click)="changePage(currentPage - 1)">
              ‚Üê Prev
            </button>

            <ng-container *ngFor="let page of [].constructor(totalPages); let i = index">
              <button class="btn mx-1"
                [ngClass]="{ 'btn-primary': currentPage === i + 1, 'btn-light': currentPage !== i + 1 }"
                (click)="changePage(i + 1)">
                {{ i + 1 }}
              </button>
            </ng-container>

            <button class="btn btn-outline-secondary ms-2" [disabled]="currentPage === totalPages"
              (click)="changePage(currentPage + 1)">
              Next ‚Üí
            </button>
          </div>

          <!-- Right-aligned items per page -->
          <div class="items-per-page-selector ms-auto d-flex align-items-center mt-2 mt-md-0">
            <select id="itemsPerPage" class="form-select form-select-sm items-dropdown" [(ngModel)]="itemsPerPage"
              (change)="onItemsPerPageChange()">
              <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
            </select>
          </div>

        </div>


      </div>
    </div>
    <!-- Pagination Controls -->




    <!-- ===================== -->
    <!-- Modals -->
    <!-- ===================== -->

    <!-- Filter Modal -->
    <div class="modal-overlay" *ngIf="showFilterModal">
      <div class="modal-card filter-modal-card">
        <div class="modal-header d-flex justify-content-between align-items-center">
          <h5>Filter Pending Redeems</h5>
          <button class="btn-close" (click)="closeFilterModal()">&times;</button>
        </div>
        <form (ngSubmit)="applyFilter()" class="modal-body">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="filterRedeem" name="redeem"
              [(ngModel)]="filterSelection.redeem" />
            <label class="form-check-label" for="filterRedeem">Redeem</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="filterRemark" name="remark"
              [(ngModel)]="filterSelection.remark" />
            <label class="form-check-label" for="filterRemark">Remark</label>
          </div>
          <div class="text-end mt-3">
            <button type="button" class="btn btn-secondary me-2" (click)="closeFilterModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Apply</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Attention Modal -->
    <div class="modal-overlay" *ngIf="showAttentionModal">
      <div class="modal-card">
        <div class="modal-header d-flex justify-content-between align-items-center">
          <h5>Attention</h5>
          <button class="btn-close" (click)="closeAttentionModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p>Before requesting a redeem, you must have a payment method added.</p>
          <div class="text-end">
            <button class="btn btn-primary" (click)="openPaymentMethodModal()">Add Payment Method</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Method Modal -->
    <div class="modal-overlay" *ngIf="showPaymentMethodModal">
      <div class="modal-card">
        <div class="modal-header d-flex justify-content-between align-items-center">
          <h5>Add / Edit Payment Methods</h5>
          <button class="btn-close" (click)="closePaymentMethodModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="savePaymentMethod()" #pmForm="ngForm">
            <div class="mb-2">
              <label class="form-label">Cash App ID</label>
              <input class="form-control" name="cashApp" [(ngModel)]="paymentMethod.CashAppId" />
            </div>
            <div class="mb-2">
              <label class="form-label">PayPal ID</label>
              <input class="form-control" name="paypal" [(ngModel)]="paymentMethod.PaypalId" />
            </div>
            <div class="mb-2">
              <label class="form-label">Venmo ID</label>
              <input class="form-control" name="venmo" [(ngModel)]="paymentMethod.VenmoId" />
            </div>
            <div class="mb-2">
              <label class="form-label">Zelle ID</label>
              <input class="form-control" name="zelle" [(ngModel)]="paymentMethod.ZelleId" />
            </div>
            <div class="text-end mt-3">
              <button type="button" class="btn btn-secondary me-2" (click)="closePaymentMethodModal()">Cancel</button>
              <button type="submit" class="btn btn-success" [disabled]="isSavingPayment">
                {{ isSavingPayment ? 'Saving...' : 'SAVE' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Redeem Confirmation Modal -->
    <!-- Redeem Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showRedeemConfirmModal">
      <div class="modal-card">
        <div class="modal-header d-flex justify-content-between align-items-center">
          <h5>Redeem Amount</h5>
          <button class="btn-close" (click)="closeRedeemConfirmModal()">&times;</button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Redeem Amount</label>
            <input type="number" class="form-control" [value]="selectedAmount" readonly />
          </div>

          <div class="alert alert-secondary py-2">
            Redeem Service Fee @ {{ activeServiceFee?.serviceFeePercent || 0 }}%
          </div>

          <div class="alert alert-light py-2 border">
            Total amount to be redeemed = {{ netRedeemAmount || 0 }}
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-end">
          <button class="btn btn-secondary me-2" (click)="closeRedeemConfirmModal()">Cancel</button>
          <button class="btn btn-primary" (click)="confirmRedeem()">Confirm</button>
        </div>
      </div>
    </div>



  </div>
</div>